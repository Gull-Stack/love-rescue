// Prisma Schema for Marriage Rescue App
// PostgreSQL with UUID primary keys and JSONB for flexible data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User subscription status
enum SubscriptionStatus {
  trial
  paid
  premium
  expired
}

// User roles for RBAC
enum UserRole {
  user
  therapist
  admin
}

// Relationship status
enum RelationshipStatus {
  active
  paused
  ended
}

// Mediator status
enum MediatorStatus {
  active
  inactive
}

// Meeting status
enum MeetingStatus {
  scheduled
  completed
  cancelled
}

// Assessment types
enum AssessmentType {
  attachment
  personality
  wellness_behavior
  negative_patterns_closeness
  love_language
  human_needs
  gottman_checkup
  emotional_intelligence
  conflict_style
  differentiation
  hormonal_health
  physical_vitality
}

// Therapist assignment status
enum AssignmentStatus {
  active
  revoked
}

// Shared goal status
enum GoalStatus {
  active
  completed
  abandoned
}

// Task priority
enum TaskPriority {
  high
  medium
  low
}

// User account
model User {
  id                 String             @id @default(uuid()) @db.Uuid
  email              String             @unique @db.VarChar(255)
  passwordHash       String?            @map("password_hash") @db.VarChar(255)
  googleId           String?            @unique @map("google_id") @db.VarChar(255)
  authProvider       String             @default("email") @map("auth_provider") @db.VarChar(20)
  biometricKey       String?            @map("biometric_key") @db.VarChar(500)
  biometricKeyId     String?            @map("biometric_key_id") @db.VarChar(255)
  firstName          String?            @map("first_name") @db.VarChar(100)
  lastName           String?            @map("last_name") @db.VarChar(100)
  gender             String?            @db.VarChar(20)
  role               UserRole           @default(user)
  subscriptionStatus SubscriptionStatus @default(trial) @map("subscription_status")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  stripeCustomerId   String?            @map("stripe_customer_id") @db.VarChar(255)
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  assessments             Assessment[]
  dailyLogs               DailyLog[]
  gratitudeEntries        GratitudeEntry[]
  auditLogs               AuditLog[]
  videoCompletions        VideoCompletion[]
  relationshipsAsUser1    Relationship[]    @relation("User1Relationship")
  relationshipsAsUser2    Relationship[]    @relation("User2Relationship")
  consentLogs             ConsentLog[]
  sharedGoalsCreated      SharedGoal[]      @relation("GoalCreator")
  assignedTasks           TherapistTask[]   @relation("TaskAssignee")
  pushSubscriptions       PushSubscription[]
  notificationPreferences NotificationPreferences?

  @@map("users")
  @@index([email])
  @@index([subscriptionStatus])
  @@index([role])
}

// Therapist profiles (separate from User for security isolation)
model Therapist {
  id             String   @id @default(uuid()) @db.Uuid
  email          String   @unique @db.VarChar(255)
  passwordHash   String   @map("password_hash") @db.VarChar(255)
  firstName      String   @map("first_name") @db.VarChar(100)
  lastName       String   @map("last_name") @db.VarChar(100)
  licenseNumber  String?  @map("license_number") @db.VarChar(100)
  licenseState   String?  @map("license_state") @db.VarChar(10)
  apiKeyHash     String?  @unique @map("api_key_hash") @db.VarChar(255)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  assignments    TherapistAssignment[]
  tasks          TherapistTask[]       @relation("TaskTherapist")

  @@map("therapists")
  @@index([email])
  @@index([apiKeyHash])
}

// Therapist-to-couple assignments
model TherapistAssignment {
  id             String           @id @default(uuid()) @db.Uuid
  therapistId    String           @map("therapist_id") @db.Uuid
  relationshipId String           @map("relationship_id") @db.Uuid
  status         AssignmentStatus @default(active)
  assignedAt     DateTime         @default(now()) @map("assigned_at")
  revokedAt      DateTime?        @map("revoked_at")

  // Relations
  therapist    Therapist    @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)

  @@unique([therapistId, relationshipId])
  @@map("therapist_assignments")
  @@index([therapistId])
  @@index([relationshipId])
  @@index([status])
}

// Relationship unit (1 or 2 users)
model Relationship {
  id                    String             @id @default(uuid()) @db.Uuid
  user1Id               String             @map("user1_id") @db.Uuid
  user2Id               String?            @map("user2_id") @db.Uuid
  inviteCode            String?            @unique @map("invite_code") @db.VarChar(50)
  inviteEmail           String?            @map("invite_email") @db.VarChar(255)
  inviteExpiresAt       DateTime?          @map("invite_expires_at")
  status                RelationshipStatus @default(active)
  sharedConsent         Boolean            @default(false) @map("shared_consent")
  user1TherapistConsent Boolean            @default(false) @map("user1_therapist_consent")
  user2TherapistConsent Boolean            @default(false) @map("user2_therapist_consent")
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")

  // Relations
  user1              User                  @relation("User1Relationship", fields: [user1Id], references: [id], onDelete: Cascade)
  user2              User?                 @relation("User2Relationship", fields: [user2Id], references: [id], onDelete: SetNull)
  matchups           Matchup[]
  strategies         Strategy[]
  therapistTasks     TherapistTask[]
  meetings           Meeting[]
  consentLogs        ConsentLog[]
  sharedGoals        SharedGoal[]
  therapistAssignments TherapistAssignment[]

  @@map("relationships")
  @@index([user1Id])
  @@index([user2Id])
  @@index([inviteCode])
  @@index([status])
}

// Individual assessment results
model Assessment {
  id          String         @id @default(uuid()) @db.Uuid
  userId      String         @map("user_id") @db.Uuid
  type        AssessmentType
  responses   Json           @db.JsonB
  score       Json           @db.JsonB
  completedAt DateTime       @default(now()) @map("completed_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("assessments")
  @@index([userId])
  @@index([type])
  @@index([userId, type])
}

// Matchup score between partners
model Matchup {
  id             String   @id @default(uuid()) @db.Uuid
  relationshipId String   @map("relationship_id") @db.Uuid
  score          Int      @db.SmallInt
  alignments     Json     @db.JsonB // { compatible: [], misses: [] }
  details        Json?    @db.JsonB // Detailed breakdown
  generatedAt    DateTime @default(now()) @map("generated_at")

  // Relations
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)

  @@map("matchups")
  @@index([relationshipId])
  @@index([generatedAt])
}

// Daily interaction logs
model DailyLog {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  date             DateTime @db.Date
  positiveCount    Int      @default(0) @map("positive_count")
  negativeCount    Int      @default(0) @map("negative_count")
  ratio            Float?
  journalEntry     String?  @map("journal_entry") @db.Text
  bidsTurned       Int?     @map("bids_turned")
  closenessScore   Int?     @map("closeness_score") @db.SmallInt
  mood             Int?     @db.SmallInt // 1-10 scale
  isPrivate        Boolean  @default(false) @map("is_private")
  therapistVisible Boolean  @default(true) @map("therapist_visible")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_logs")
  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

// Weekly/cycle strategies
model Strategy {
  id              String   @id @default(uuid()) @db.Uuid
  relationshipId  String   @map("relationship_id") @db.Uuid
  cycleNumber     Int      @default(1) @map("cycle_number")
  week            Int      @db.SmallInt
  dailyActivities Json     @map("daily_activities") @db.JsonB
  weeklyGoals     Json     @map("weekly_goals") @db.JsonB
  progress        Float    @default(0) // 0-100
  isActive        Boolean  @default(true) @map("is_active")
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime @map("end_date") @db.Date
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)

  @@map("strategies")
  @@index([relationshipId])
  @@index([isActive])
  @@index([relationshipId, week])
}

// Therapist-assigned tasks
model TherapistTask {
  id               String       @id @default(uuid()) @db.Uuid
  relationshipId   String       @map("relationship_id") @db.Uuid
  therapistId      String?      @map("therapist_id") @db.Uuid
  therapistEmail   String?      @map("therapist_email") @db.VarChar(255)
  assignedToUserId String?      @map("assigned_to_user_id") @db.Uuid
  taskDescription  String       @map("task_description") @db.Text
  notes            String?      @db.Text
  dueDate          DateTime?    @map("due_date") @db.Date
  priority         TaskPriority @default(medium)
  completed        Boolean      @default(false)
  completedAt      DateTime?    @map("completed_at")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  therapist    Therapist?   @relation("TaskTherapist", fields: [therapistId], references: [id], onDelete: SetNull)
  assignedTo   User?        @relation("TaskAssignee", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  @@map("therapist_tasks")
  @@index([relationshipId])
  @@index([therapistId])
  @@index([assignedToUserId])
  @@index([completed])
}

// HIPAA-compliant audit logging
model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  action    String   @db.VarChar(100)
  resource  String?  @db.VarChar(100)
  resourceId String? @map("resource_id") @db.VarChar(100)
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  metadata  Json?    @db.JsonB
  timestamp DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([resource, resourceId])
}

// Granular access logging for HIPAA compliance
model AccessLog {
  id              String   @id @default(uuid()) @db.Uuid
  accessorId      String   @map("accessor_id") @db.Uuid
  accessorRole    String   @map("accessor_role") @db.VarChar(20)
  resourceType    String   @map("resource_type") @db.VarChar(50)
  resourceId      String?  @map("resource_id") @db.Uuid
  resourceOwnerId String?  @map("resource_owner_id") @db.Uuid
  action          String   @db.VarChar(20)
  accessGranted   Boolean  @map("access_granted")
  reason          String?  @db.VarChar(255)
  ipAddress       String?  @map("ip_address") @db.VarChar(45)
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("access_logs")
  @@index([accessorId, createdAt(sort: Desc)])
  @@index([resourceOwnerId, createdAt(sort: Desc)])
}

// Consent change audit trail
model ConsentLog {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  relationshipId String   @map("relationship_id") @db.Uuid
  consentType    String   @map("consent_type") @db.VarChar(30)
  granted        Boolean
  ipAddress      String?  @map("ip_address") @db.VarChar(45)
  grantedAt      DateTime @default(now()) @map("granted_at")

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)

  @@map("consent_logs")
  @@index([userId, consentType, grantedAt(sort: Desc)])
}

// Shared couple goals
model SharedGoal {
  id             String     @id @default(uuid()) @db.Uuid
  relationshipId String     @map("relationship_id") @db.Uuid
  title          String     @db.VarChar(255)
  description    String?    @db.Text
  targetDate     DateTime?  @map("target_date") @db.Date
  status         GoalStatus @default(active)
  createdBy      String     @map("created_by") @db.Uuid
  completedAt    DateTime?  @map("completed_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // Relations
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  creator      User         @relation("GoalCreator", fields: [createdBy], references: [id])

  @@map("shared_goals")
  @@index([relationshipId])
  @@index([status])
}

// Email verification and password reset tokens
model Token {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @db.VarChar(255)
  token     String   @unique @db.VarChar(255)
  type      String   @db.VarChar(50) // 'email_verify', 'password_reset', 'invite'
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("tokens")
  @@index([email])
  @@index([token])
  @@index([type])
}

// Daily insight content (14-week course, 98 total)
model DailyInsight {
  id                  String @id @default(uuid()) @db.Uuid
  week                Int    @db.SmallInt
  day                 Int    @db.SmallInt
  baseText            String @map("base_text") @db.Text
  personalizationTags Json?  @map("personalization_tags") @db.JsonB

  @@unique([week, day])
  @@map("daily_insights")
}

// Daily video content (14-week course, 98 total)
model DailyVideo {
  id          String @id @default(uuid()) @db.Uuid
  week        Int    @db.SmallInt
  day         Int    @db.SmallInt
  youtubeId   String @map("youtube_id") @db.VarChar(20)
  title       String @db.VarChar(255)
  description String @db.Text

  // Relations
  completions VideoCompletion[]

  @@unique([week, day])
  @@map("daily_videos")
}

// Track user video watching
model VideoCompletion {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  videoId   String   @map("video_id") @db.Uuid
  watchedAt DateTime @default(now()) @map("watched_at")

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  video DailyVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@map("video_completions")
  @@index([userId])
  @@index([videoId])
}

// Neutral facilitators for mediated meetings
model Mediator {
  id                String         @id @default(uuid()) @db.Uuid
  name              String         @db.VarChar(200)
  bio               String         @db.Text
  googleCalendarId  String         @unique @map("google_calendar_id") @db.VarChar(255)
  availabilityRules Json           @map("availability_rules") @db.JsonB
  rate              Float          @default(0)
  status            MediatorStatus @default(active)
  createdAt         DateTime       @default(now()) @map("created_at")

  // Relations
  meetings Meeting[]

  @@map("mediators")
  @@index([status])
}

// Scheduled mediation sessions
model Meeting {
  id              String        @id @default(uuid()) @db.Uuid
  relationshipId  String        @map("relationship_id") @db.Uuid
  mediatorId      String        @map("mediator_id") @db.Uuid
  scheduledAt     DateTime      @map("scheduled_at")
  duration        Int           @default(30) @db.SmallInt
  meetLink        String?       @map("meet_link") @db.VarChar(255)
  calendarEventId String?       @map("calendar_event_id") @db.VarChar(255)
  status          MeetingStatus @default(scheduled)
  week            Int           @db.SmallInt
  notes           String?       @db.Text
  createdBy       String        @map("created_by") @db.Uuid
  partnerConsent  Boolean       @default(false) @map("partner_consent")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  mediator     Mediator     @relation(fields: [mediatorId], references: [id])

  @@unique([relationshipId, week])
  @@map("meetings")
  @@index([relationshipId])
  @@index([mediatorId])
  @@index([status])
  @@index([scheduledAt])
}

// Daily gratitude entries â€” one per day per user
model GratitudeEntry {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  date        DateTime @db.Date
  text        String   @db.Text  // what they appreciate about their partner
  category    String?  @db.VarChar(50)  // optional: kindness, effort, humor, presence, support, growth, love, other
  isShared    Boolean  @default(false) @map("is_shared")  // opted to share with partner
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("gratitude_entries")
  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

// Push notification subscriptions for PWA
model PushSubscription {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  endpoint     String   @unique @db.Text  // Push service endpoint URL
  p256dh       String   @db.VarChar(255)  // Public key for encryption
  auth         String   @db.VarChar(255)  // Auth secret
  userAgent    String?  @map("user_agent") @db.VarChar(500)  // Device info
  enabled      Boolean  @default(true)    // User can disable without deleting
  lastUsed     DateTime? @map("last_used")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
  @@index([userId])
  @@index([enabled])
}

// Notification preferences per user
model NotificationPreferences {
  id                    String   @id @default(uuid()) @db.Uuid
  userId                String   @unique @map("user_id") @db.Uuid
  dailyReminderEnabled  Boolean  @default(true) @map("daily_reminder_enabled")
  dailyReminderTime     String   @default("09:00") @map("daily_reminder_time") @db.VarChar(5)  // HH:MM format
  timezone              String   @default("America/Denver") @db.VarChar(50)
  partnerActivityAlerts Boolean  @default(true) @map("partner_activity_alerts")
  weeklyDigest          Boolean  @default(true) @map("weekly_digest")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

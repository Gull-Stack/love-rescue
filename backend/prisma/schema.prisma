// Prisma Schema for Marriage Rescue App
// PostgreSQL with UUID primary keys and JSONB for flexible data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User subscription status
enum SubscriptionStatus {
  trial
  paid
  expired
}

// Assessment types
enum AssessmentType {
  attachment
  personality
  wellness_behavior
  negative_patterns_closeness
}

// User account
model User {
  id                 String             @id @default(uuid()) @db.Uuid
  email              String             @unique @db.VarChar(255)
  passwordHash       String             @map("password_hash") @db.VarChar(255)
  biometricKey       String?            @map("biometric_key") @db.VarChar(500)
  biometricKeyId     String?            @map("biometric_key_id") @db.VarChar(255)
  firstName          String?            @map("first_name") @db.VarChar(100)
  lastName           String?            @map("last_name") @db.VarChar(100)
  subscriptionStatus SubscriptionStatus @default(trial) @map("subscription_status")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  stripeCustomerId   String?            @map("stripe_customer_id") @db.VarChar(255)
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  assessments        Assessment[]
  dailyLogs          DailyLog[]
  auditLogs          AuditLog[]
  relationshipsAsUser1 Relationship[] @relation("User1Relationship")
  relationshipsAsUser2 Relationship[] @relation("User2Relationship")

  @@map("users")
  @@index([email])
  @@index([subscriptionStatus])
}

// Relationship unit (1 or 2 users)
model Relationship {
  id            String    @id @default(uuid()) @db.Uuid
  user1Id       String    @map("user1_id") @db.Uuid
  user2Id       String?   @map("user2_id") @db.Uuid
  inviteCode    String?   @unique @map("invite_code") @db.VarChar(50)
  inviteEmail   String?   @map("invite_email") @db.VarChar(255)
  sharedConsent Boolean   @default(false) @map("shared_consent")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  user1          User            @relation("User1Relationship", fields: [user1Id], references: [id], onDelete: Cascade)
  user2          User?           @relation("User2Relationship", fields: [user2Id], references: [id], onDelete: SetNull)
  matchups       Matchup[]
  strategies     Strategy[]
  therapistTasks TherapistTask[]

  @@map("relationships")
  @@index([user1Id])
  @@index([user2Id])
  @@index([inviteCode])
}

// Individual assessment results
model Assessment {
  id          String         @id @default(uuid()) @db.Uuid
  userId      String         @map("user_id") @db.Uuid
  type        AssessmentType
  responses   Json           @db.JsonB
  score       Json           @db.JsonB
  completedAt DateTime       @default(now()) @map("completed_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("assessments")
  @@index([userId])
  @@index([type])
  @@index([userId, type])
}

// Matchup score between partners
model Matchup {
  id             String   @id @default(uuid()) @db.Uuid
  relationshipId String   @map("relationship_id") @db.Uuid
  score          Int      @db.SmallInt
  alignments     Json     @db.JsonB // { compatible: [], misses: [] }
  details        Json?    @db.JsonB // Detailed breakdown
  generatedAt    DateTime @default(now()) @map("generated_at")

  // Relations
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)

  @@map("matchups")
  @@index([relationshipId])
  @@index([generatedAt])
}

// Daily interaction logs
model DailyLog {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  date           DateTime @db.Date
  positiveCount  Int      @default(0) @map("positive_count")
  negativeCount  Int      @default(0) @map("negative_count")
  ratio          Float?
  journalEntry   String?  @map("journal_entry") @db.Text
  bidsTurned     Int?     @map("bids_turned")
  closenessScore Int?     @map("closeness_score") @db.SmallInt
  mood           Int?     @db.SmallInt // 1-10 scale
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_logs")
  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

// Weekly/cycle strategies
model Strategy {
  id              String   @id @default(uuid()) @db.Uuid
  relationshipId  String   @map("relationship_id") @db.Uuid
  cycleNumber     Int      @default(1) @map("cycle_number")
  week            Int      @db.SmallInt
  dailyActivities Json     @map("daily_activities") @db.JsonB
  weeklyGoals     Json     @map("weekly_goals") @db.JsonB
  progress        Float    @default(0) // 0-100
  isActive        Boolean  @default(true) @map("is_active")
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime @map("end_date") @db.Date
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)

  @@map("strategies")
  @@index([relationshipId])
  @@index([isActive])
  @@index([relationshipId, week])
}

// Therapist-assigned tasks
model TherapistTask {
  id              String    @id @default(uuid()) @db.Uuid
  relationshipId  String    @map("relationship_id") @db.Uuid
  therapistId     String?   @map("therapist_id") @db.Uuid
  therapistEmail  String?   @map("therapist_email") @db.VarChar(255)
  taskDescription String    @map("task_description") @db.Text
  notes           String?   @db.Text
  dueDate         DateTime? @map("due_date") @db.Date
  completed       Boolean   @default(false)
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  relationship Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)

  @@map("therapist_tasks")
  @@index([relationshipId])
  @@index([therapistId])
  @@index([completed])
}

// HIPAA-compliant audit logging
model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  action    String   @db.VarChar(100)
  resource  String?  @db.VarChar(100)
  resourceId String? @map("resource_id") @db.VarChar(100)
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  metadata  Json?    @db.JsonB
  timestamp DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([resource, resourceId])
}

// Email verification and password reset tokens
model Token {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @db.VarChar(255)
  token     String   @unique @db.VarChar(255)
  type      String   @db.VarChar(50) // 'email_verify', 'password_reset', 'invite'
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("tokens")
  @@index([email])
  @@index([token])
  @@index([type])
}
